<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>SecServer</title>
<script type="text/javascript" src="static/jquery-1.11.2.min.js"></script>
<script type="text/javascript">
function sendForm() {
	var text = $('#text').val();
	if (text.trim().length == 0)
		return false;

	$('#text').val("");
	$.ajax("/send/"+encodeURIComponent(text), {
		beforeSend: function(xhr) {
		    if (xhr.overrideMimeType)
		        xhr.overrideMimeType("text/plain");
		},
		success: function(res) {
			if (res != "OK")
				alert("Error: "+res);
		}, error: function(xhr, res) {
			alert("Error: "+res);
		}
	});
	$('#text').focus();
	return false;
}
function number2digits(n) {
	if (n <= 9)
		return '0' + n;
	return '' + n;
}
var lineSplitRegExp = /\r\n|\n\r|\n|\r/g; 
var lastMessageId = "";
function splitMessages(res) {
	var lines = res.replace(lineSplitRegExp, "\n").split("\n");
	lines.pop();
	return lines;
}
function htmlEscape(a) {
	return $('<div/>').text(a).html();
}
var users = null;
var userToDiv = {};
function addUser(username) {
	if (userToDiv[username]) return;
	var userDiv = $('<div/>');
	userDiv.text(username);
	users.append(userDiv);
	userToDiv[username] = userDiv;
}
function removeUser(username) {
	var user = userToDiv[username];
	if (user) {
		user.remove();
		delete userToDiv[username];
	}
}
function getClassFromMessageType(messageType, userContainedInLine) {
	switch(messageType) {
		case '+':
			return "msg_login";
		case '-':
			return "msg_logoff";
		case 'm':
			return userContainedInLine ? "msg_username" : "msg";
		case 's':
			return "system";
		default:
			return "msg";
	}
}
var soundEnabled = true;
var soundNotify = null;
function playSound_Notification() {
	if (!soundEnabled) return;
	if (soundNotify == null)
		soundNotify = new Audio("/static/notification.ogg");
	soundNotify.play();
}
function escapeRegExp(str) {
  return str.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g, "\\$&");
}
function appendChatMessage(line) {
	var splitLine = line.split("|");
	var messageIdStr = splitLine[0];
	var message = splitLine[1];
	var splitMessageIdStr = messageIdStr.split(":");
	var messageType = splitMessageIdStr[0];
	var messageTime = splitMessageIdStr[1];
	var messageId = splitMessageIdStr[2];
	lastMessageId = messageTime + ":" + messageId;
	var timestamp = Number(messageTime);
	var messageTime = new Date(timestamp * 1000);
	var messageTimeStr = number2digits(messageTime.getHours()) + ":" + number2digits(messageTime.getMinutes()) + ":" + number2digits(messageTime.getSeconds());
	var colonPos = message.indexOf(":");
	var user = message.substr(0, colonPos);
	var message = message.substr(colonPos+1);

	var userContainedInLine;
	if (myUserName) {
		if (message.match(new RegExp("(^|[@ ])" + escapeRegExp(myUserName) + "([: ]|$)", "i"))) {
			userContainedInLine = true;
		}
	}

	if (messageType == '-' || messageType == '+') {
		if (messageType == '+')
			addUser(user);
		else
			removeUser(user);
		user = "";
	}
	if (user == "") user = "System";

	var classType = getClassFromMessageType(messageType, userContainedInLine);
	chatlog.append('<tr class="'+classType+'"><td>' + messageTimeStr + "</td><td>|</td><td><b>" + htmlEscape(user) + "</b></td><td>|</td><td width='100%'>" + htmlEscape(message) + '</td></tr>');
	if (!focused) ++unreadMessageCount;
}
function cleanChatMessages() {
	var chatLinesToKeep = 300;
	var children = chatlog.find('tr');
	if (children.length > chatLinesToKeep)
		children.slice(0,children.length - chatLinesToKeep).remove();
}
function refreshChat() {
	$.ajax("/get/"+lastMessageId, {
		beforeSend: function(xhr) {
		    if (xhr.overrideMimeType)
		        xhr.overrideMimeType("text/plain");
		},
		success: function(res) {
			var lines = splitMessages(res);

			var currentScrollBottomValue = chatlog.height() - chat.height();
			var scrollToBottom = chat.scrollTop() >= currentScrollBottomValue;

			var oldUnreadMessageCount = unreadMessageCount;
			$(lines).each(function(i) {
				appendChatMessage(lines[i]);
			});
			cleanChatMessages();
			if (oldUnreadMessageCount != unreadMessageCount) {
				updateTitle();
				playSound_Notification();
			}

			if (scrollToBottom)
				chat.scrollTop(chatlog.height()-chat.height());
		}
	});
}
var unreadMessageCount = 0;
var focused = true;
function updateTitle() {
	if (focused)
		document.title = 'SecServer';
	else
		document.title = '('+unreadMessageCount+') SecServer';
}
var myUserName = null;
var lastReadBar = null;
$(function() {
	chat = $('#chat');
	chatlog = $('#chatlog');
	users = $('#users');

	$.ajax("/whoami/", {
		beforeSend: function(xhr) {
		    if (xhr.overrideMimeType)
		        xhr.overrideMimeType("text/plain");
		},
		success: function(res) {
			myUserName = res;
		}
	});
	$.ajax("/get/", {
		beforeSend: function(xhr) {
		    if (xhr.overrideMimeType)
		        xhr.overrideMimeType("text/plain");
		},
		success: function(res) {
			var lines = splitMessages(res);
			$(lines).each(function(i) {
				appendChatMessage(lines[i]);
			});
			cleanChatMessages();

			chat.scrollTop(chatlog.height()-chat.height());
		}
	});
	$.ajax("/users/", {
		beforeSend: function(xhr) {
		    if (xhr.overrideMimeType)
		        xhr.overrideMimeType("text/plain");
		},
		success: function(res) {
			var lines = splitMessages(res);
			$(lines).each(function(i) {
				addUser(lines[i]);
			});
		}
	});
	$(window).blur(function() {
		focused = false;
		updateTitle();
		var top = chat.scrollTop();
		var height = chatlog.height();
		if (lastReadBar) {
			lastReadBar.remove();
		} else {
			lastReadBar = $('<tr><td class="readbar" colspan="5"></td></tr>');
		}
		chatlog.append(lastReadBar);
		chat.scrollTop(top+chatlog.height()-height);
	});
	$(window).focus(function() {
		unreadMessageCount = 0;
		focused = true;
		updateTitle();
	});
	$('#soundToggle').click(function() {
		soundEnabled = !soundEnabled;
		if (soundEnabled)
			$(this).html("Sound: On");
		else
			$(this).html("Sound: Off");
	});
	$('#soundToggle').click();
	$('#soundToggle').click();
	updateTitle();
	if ($('#styleSelect').val() != "basic") onStyleChange();
	window.setInterval("refreshChat()", 1000);
});
function onStyleChange() {
	$('#style').prop('href','/static/'+$('#styleSelect').val()+'.css');
}
</script>
<link id='style' rel="stylesheet" type="text/css" href="static/basic.css" />
</head>
<body>
<div id="users">
</div>
<div id="chat">
<table id="chatlog" width="100%">
</table>
</div>
<div style="clear:both"></div>
<div>
<form onsubmit="return sendForm()">
<input style="width:100%;box-sizing:border-box" id="text" type="text" autocomplete="off" />
</form>
<button id='soundToggle'></button>
Style: <select id='styleSelect' onchange="onStyleChange()">
<option>basic</option>
<option>zenburn</option>
</select>
<a href="https://github.com/icetruckde/SecServer" target="_blank">Project on GitHub</a></div>
</body>
</html>
