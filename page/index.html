<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>SecServer</title>
<script type="text/javascript" src="static/jquery-1.11.2.min.js"></script>
<script type="text/javascript">
function sendForm() {
	var text = $('#text').val();
	if (text.trim().length == 0)
		return false;

	$('#text').val("");
	$.ajax("/send/"+encodeURIComponent(text), {
		beforeSend: function(xhr) {
		    if (xhr.overrideMimeType)
		        xhr.overrideMimeType("text/plain");
		},
		success: function(res) {
			if (res != "OK")
				alert("Error: "+res);
		}, error: function(xhr, res) {
			alert("Error: "+res);
		}
	});
	$('#text').focus();
	return false;
}
function number2digits(n) {
	if (n <= 9)
		return '0' + n;
	return '' + n;
}
var lineSplitRegExp = /\r\n|\n\r|\n|\r/g; 
var lastMessageId = "";
function splitMessages(res) {
	var lines = res.replace(lineSplitRegExp, "\n").split("\n");
	lines.pop();
	return lines;
}
function htmlEscape(a) {
	return $('<div/>').text(a).html();
}
function getClassFromMessageType(messageType) {
	switch(messageType) {
		case '+':
			return "msg_login";
		case '-':
			return "msg_logoff";
		case 'm':
			return "msg";
		case 's':
			return "system";
	}
}
var soundEnabled = true;
var soundNotify = null;
function playSound_Notification() {
	if (!soundEnabled) return;
	if (soundNotify == null)
		soundNotify = new Audio("/static/notification.ogg");
	soundNotify.play();
}
function appendChatMessage(line) {
	var [messageIdStr, message] = line.split("|");
	var [messageType, messageTime, messageId] = messageIdStr.split(":");
	lastMessageId = messageTime + ":" + messageId;
	var timestamp = Number(messageTime);
	var messageTime = new Date(timestamp * 1000);
	var messageTimeStr = number2digits(messageTime.getHours()) + ":" + number2digits(messageTime.getMinutes()) + ":" + number2digits(messageTime.getSeconds());
	var colonPos = message.indexOf(":");
	var user = message.substr(0, colonPos);
	var message = message.substr(colonPos+1);

	if (messageType == '-' || messageType == '+') {
		// @TODO: userlist actions
		user = "";
	}
	if (user == "") user = "System";

	var classType = getClassFromMessageType(messageType);
	chatlog.append('<tr class="'+classType+'"><td>' + messageTimeStr + "</td><td>|</td><td><b>" + htmlEscape(user) + "</b></td><td>|</td><td>" + htmlEscape(message) + '</td></tr>');
	if (!focused) ++unreadMessageCount;
}
function cleanChatMessages() {
	var chatLinesToKeep = 30;
	var children = chatlog.find('tr');
	if (children.length > chatLinesToKeep)
		children.slice(0,children.length - chatLinesToKeep).remove();
}
function refreshChat() {
	$.ajax("/get/"+lastMessageId, {
		beforeSend: function(xhr) {
		    if (xhr.overrideMimeType)
		        xhr.overrideMimeType("text/plain");
		},
		success: function(res) {
			var lines = splitMessages(res);

			var currentScrollBottomValue = chatlog.height() - chat.height();
			var scrollToBottom = chat.scrollTop() == currentScrollBottomValue;

			var oldUnreadMessageCount = unreadMessageCount;
			$(lines).each(function(i) {
				appendChatMessage(lines[i]);
			});
			cleanChatMessages();
			if (oldUnreadMessageCount != unreadMessageCount) {
				updateTitle();
				playSound_Notification();
			}

			if (scrollToBottom)
				chat.scrollTop(chatlog.height()-chat.height());
		}
	});
}
var unreadMessageCount = 0;
var focused = true;
function updateTitle() {
	if (focused)
		document.title = 'SecServer';
	else
		document.title = '('+unreadMessageCount+') SecServer';
}
$(function() {
	chat = $('#chat');
	chatlog = $('#chatlog');
	$.ajax("/get/", {
		beforeSend: function(xhr) {
		    if (xhr.overrideMimeType)
		        xhr.overrideMimeType("text/plain");
		},
		success: function(res) {
			var lines = splitMessages(res);
			$(lines).each(function(i) {
				appendChatMessage(lines[i]);
			});
			cleanChatMessages();

			chat.scrollTop(chatlog.height()-chat.height());
		}
	});
	$(window).blur(function() {
		focused = false;
		updateTitle();
	});
	$(window).focus(function() {
		unreadMessageCount = 0;
		focused = true;
		updateTitle();
	});
	$('#soundToggle').click(function() {
		soundEnabled = !soundEnabled;
		if (soundEnabled)
			$(this).html("Sound: On");
		else
			$(this).html("Sound: Off");
	});
	$('#soundToggle').click();
	$('#soundToggle').click();
	updateTitle();
	window.setInterval("refreshChat()", 1000);
})
</script>
<link rel="stylesheet" type="text/css" href="static/style.css" />
</head>
<body>
<div id="chat">
<table id="chatlog">
</table>
</div>
<div><form onsubmit="return sendForm()"><input id="text" type="text" autocomplete="off" /><input type="submit" /></form><button id='soundToggle'></button></div>
</body>
</html>
